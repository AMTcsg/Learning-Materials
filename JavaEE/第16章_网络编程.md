## 第16章_网络编程

## 1. 网络编程概述

Java 是 Internet 上的语言，它从语言级上提供了对网络应用程序的支持，程序员能够很容易开发常见的网络应用程序。

Java 提供的网络类库，可以实现无痛的网络连接，联网的底层细节被隐藏在Java的本机安装系统里，由 JVM 进行控制。并且 Java 实现了一个可以跨平台的网络库，`程序员面对的是一个统一的网络编程环境`

### 1.1 软件架构

- **C/S架构：**全称为 Client / Server 结构，是指客户端与服务器结构。常见程序有QQ、美团app、360安全卫士等软件。

   ![CS架构和BS架构的区别_cs程序员易上手的bs前端框架-CSDN博客](https://img-blog.csdnimg.cn/20190520114814409.gif) 

- **B/S架构：**全称为 Browser / Server 结构，是指浏览器和服务器结构。常见的浏览器有IE、谷歌、火狐等。 

   ![B/S架构与C/S架构有什么区别 - 编程语言 - 亿速云](https://cache.yisu.com/upload/information/20200318/98/38916.jpg)

两种架构各有优势，但是无论哪种架构，都离不开网络的支持。**网络编程**，就是在一定的协议下，实现两天计算机的通信的程序

### 1.2 网络基础

- **计算机网络：**

  把分布在不同地理区域的计算机与专门的外部设备用通信线路互连成一个规模大、功能强的网络系统，从而使众多的计算机可以方便地互相传递信息、共享硬件、软件、数据信息等资源

- **网络编程的目的：**直接或间接地通过网络协议与其他计算机实现数据交换，进行通讯

- **网络编程中有三个主要的问题：**

  - 问题1：如何准确地定位网络上一台或多台主机
  - 问题2：如何定位主机上的特定应用
  - 问题3：找到主机后，如何可靠、高效地进行数据传输

## 2. 网络通信要素

### 2.1 如何实现网络中的主机互相通信

- 通信双方地址
  - IP
  - 端口号
- 一定的规则：不同的硬件、操作系统之间的通信，所有的这一切都需要一种规则。而我们就把这种规则称为协议，即网络通信协议

### 2.2 通信要素一：IP地址和域名

#### 2.2.1 IP地址

**IP地址：指互联网协议地址（Internet Protocol Address）**，俗称IP。IP地址用来给网络中的一台计算机设备做唯一的编号。假如我们把”个人电脑“比作”一台电话“的话，那么”IP地址“就相当于”电话号码“

**IP地址发呢类方式一：**

- `IPv4`：是一个32位的二进制数，通常被分为4个字节，表示成 `a.b.c.d` 的形式，以点分 `十进制` 表示，例如 `192.168.65.100`。其中a、b、c、d都是0~255之间的十进制整数

  -  ![【网工知识】IP地址详解 - 知乎](https://pic1.zhimg.com/v2-8807d42c3002d6574650c3bc1a1a4330_r.jpg) 

  - 这种方式最多可以表示42亿个。其中，30亿都在北美，亚洲4亿，中国2.9亿。2011年初已经用尽

  - IP地址  =  网络地址 + 主机地址

    - 网络地址：标识计算机或网络设备所在的网段 
    - 主机地址：标识特定主机或网络设备

    <center class="half">
        <img src="https://www.alloll.com/uploads/allimg/191124/1-191124094941P1.jpg" width="300"/>
        <img src="https://ts1.cn.mm.bing.net/th/id/R-C.8a385b7a452950ebfdbdcf7eaae3ea9f?rik=3eVexTy9jvSHoA&riu=http%3a%2f%2fimages2015.cnblogs.com%2fblog%2f603942%2f201610%2f603942-20161024110358546-1282772232.png&ehk=xruosb9en3VmtsMV5A6Wg19%2fMNgrarPhNfZA%2fwqgalc%3d&risl=&pid=ImgRaw&r=0" width="300"/>
    </center>

    其中，E类用于科研

- `IPv6`：由于互联网的蓬勃发展，IP地址的需求量愈来愈大，但是网络地址资源有限，使得IP的分配越发紧张。

  为了扩大地址空间，拟通过IPv6重新定义地址空间，采用128位地址长度，共16个字节，写成8个无符号整数，每个整数用4个十六进制位标识，数之间用冒号隔开。比如：`ABCD:EF01:2345:6789:EF01:2345:6789`，按保守方法估算IPv6实际可分配的地址，整个地球的每平方面积上仍可分配1000多个地址，这样就解决了网络地址资源数量不够的问题。2012年6月6日，国际互联网协会举办了世界IPv6启动纪念日，这一天，全球IPv6网络正式启动。多家知名网站，如Google、Facebook和Yahoo等，于当天全球标准时间0点（北京时间8点整）开始永久性支持IPv6访问。2018年6月，三大运营商联合阿里云宣布，将全面对外提供IPv6服务，并计划在2025年助推中国互联网真正实现”IPv6 Only“

  在IPv6的设计过程中除了一劳永逸地解决了地址短缺问题以外，还考虑了在IPv4中解决不好的其他问题，主要有端到端IP连接、服务质量（QoS）、安全性、多播、移动性、即插即用等

**IP地址分类方式二**

公网地址（万维网使用）和私有地址（局域网使用）。192.168.开头的就是私有地址，范围即为192.168.0.0-192.168.255.255，专门位组织机构内部使用。

**常用命令：**

- 查看本机IP地址，在控制台输入：

```
ipconfig
```

- 查看网络是否连通，在控制台输入：

```
ping IP地址
ping 220.181.57.216
```

**特殊的IP地址：**

- 本地回环地址（hostAddress）：`127.0.0.1`
- 主机名（hostName）：`localhost`

#### 2.2.2 域名

Internet上的主机有两种方式表示地址：

- 域名(hostName)：www.atguigu.com
- IP 地址（hostAddress）：202.108.35.210

**域名解析：**因为IP地址数字不便于记忆，因此出现了域名。域名容易理解，当在连接网络时输入一个主机的域名后，域名服务器（DNS，Domain Name System，域名系统）负责将域名转化为IP 地址，这样才能和主机建立连接。

简单理解：

 ![DNS图解（秒懂 + 史上最全）-CSDN博客](https://img-blog.csdnimg.cn/img_convert/dc0cf24143fb3ab853c62f4ad925f8c9.png)

详细理解：

 ![DNS解析过程-CSDN博客](https://img-blog.csdnimg.cn/557a145e66824e6f8186300f37cd878d.png) 

1. 在浏览器中输入www.qq.com域名，操纵系统会先检查自己的本地的 `host` 文件是否有这个网址映射关系，如果有，就先调用这个IP地址映射，完成域名解析。
2. 如果 hosts 里没有这个域名的映射，则查找`本地DNS解析器缓存`，是否有这个网址映射关系，如果有，直接返回，完成域名解析
3. 如果 hosts 与本地DNS解析器缓存都没有相应的网址映射关系，首先会找TCP/IP参数中设置的首选DNS服务器，在此我们叫它 `本地DNS服务器` ，此服务器收到查询时，如果要查询的域名，包含在本地配置区域资源中，则返回解析结果给客户机，完成域名解析，此解析具有权威性
4. 如果要查询的域名，不由本地DNS服务器区域解析，但该服务器已经 `缓存` 了此网络映射关系，则调用这个IP地址映射，完成域名解析，此解析不具有权威性
5. 如果本地DNS服务器本地区域文件与缓存解析都失效，则根据本地DNS服务器的设置（是否设置转发器）进行查询，如果未用转发模式，本地DNS就把请求发送至13台根服务器，根DNS服务器收到请求后会判断这个域名(.com)是谁来授权管理，并会返回一个负责该顶级域名服务器的一个IP。本地DNS服务器收到IP信息后，将会练习负责.com域的这台服务器。这台负责.com域的服务器收到请求后，如果自己无法解析，它就会找一个管理.com域的下一级DNS服务器地址(http://qq.com)给本地服务器。当本地DNS服务器收到这个地址后，就会找（http://qq.com）域服务器。重复上面的动作，进行查询，知道找到www.qq.com主机
6. 如果用的是转发模式，此DNS服务器就会把请求转发至上一级DNS服务器，由上一级服务器进行解析，上一级服务器如果不能解析，或找根DNS或把请求转至上上级，以此循环。不管是本地DNS服务器还是用转发，还是根提示，最后都是把结果返回给本地DNS服务器，由此DNS服务器再返回给客户机

### 2.3 通信要素二：端口号

网络的通信，本质上是两个进程（应用程序）的通信。每台计算机都有很多的进程，那么在网络通信时，如何区分这些进程呢？

如果说**IP地址**可以唯一标识网络中的设备，那么**端口号**就可以唯一标识设备中的进程（应用程序）

不同的进程，设置不同的端口号

- **端口号：用2个字节表示的整数，它的取值范围是0~65535**
  - 公认端口：0~1023。被预先定义的服务通信占用，如：HTTP（80）、FTP（21）、Telnet（23）
  - 注册端口：1024~49151。分配给用户进程或应用程序。如：Tomcat（8088）、MySQL（3306）、Oracle（1521）
  - 动态/私有端口：49152~65535

如果端口号被另外一个服务或应用所占用，会导致当前程序启动失败

 ![端口和端口号的介绍-CSDN博客](https://img-blog.csdnimg.cn/20210503122025209.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDc5OTIxNw==,size_16,color_FFFFFF,t_70) 

### 2.4 通信要素三：网络通信协议

通过计算机网络可以使多台计算机实现连接，位于同一个网络中的计算机在进行连接和通信时需要遵守一定的规则，这就好比在道路中行驶的汽车一定要遵守交通规则一样

- `网络通信协议`：在计算机网络中，这些连接和通信的规则被称为网络通信协议，它对数据的传输格式、传输速率、传输步骤、出错控制等做了统一规定，通信双方必须同时遵守才能完成数据交换

**新的问题：网络协议设计内容太多、太复杂。如何解决？**

计算机网络通信涉及内容很多，比如指定源地址和目标地址，加密解密，压缩解压缩，差错控制，流量控制，路由控制，如何实现如此复杂的网络协议呢？ `通信协议分层思想`

在指定协议时，把复杂成分分解为一些简单的成分，再将它们复合起来。最常用的复合方式是层次方式，即`同层间可以通信、上一层可以调用下一层，而再与下一层不发生关系`。各层互不影响，利于系统的开发和扩展

这里由两套参考模型：

- OSI参考模型：模型过于理想化，未能在因特网上进行广泛推广
- TCP/IP参考模型（或TCP/IP协议）：事实上的国际标准

 ![img](https://developer.qcloudimg.com/http-save/yehe-8916337/6d040daf1b4ec1b8d383a957324c283d.png) 

 ![img](https://developer.qcloudimg.com/http-save/yehe-8916337/241496e30a16fed149ef78a021716879.png)

- **TCP/IP协议：**传输控制协议/因特网互联协议（Transmission Control Protocol/Internet Protocol），TCP/IP以其两个主要协议：传输控制协议（TCP）和网络互联协议（IP）而得名，实际上是一组协议，包括多个具有不同功能且互为关联的协议，是Internet最基本、最广泛的协议

**TCP/IP协议中的四层介绍：**

- `应用层`：应用层决定了向用户提供应用服务时通信的活动。主要协议有：HTTP协议、FTP协议、SNMP（简单网络管理协议）、SMTP（简单邮件传输协议）和POP3（Post Office Protocol 3的简称，即邮局协议的第3版）

- `传输层`：主要使网络程序进行通信，在进行网络通信时，可以采用TCP协议，也可以采用UDP协议。

  TCP（Transmission Control Protocol）协议，即传输控制协议，是一种面向连接的、可靠的、基于字节流的传输层通信协议。UDP（User Datagram Protocol，用户数据报协议）是一个无连接的传输层协议、提供面向事务的简单不可靠的信息传送服务

- `网络层`：网络层是整个TCP/IP协议的核心，支持网间互联的数据通信。它主要用于将传输的数据进行分组，将分组数据发送到目标计算机或者网络。而IP协议是一种非常重要的协议。IP又称为互联网协议。IP的责任就是把数据从源传送到目的地。它在源地址和目的地址之间传送一种称为数据包的东西，它还提供对数据大小的重新组装功能，以适应不同网络对包大小的要求

- `物理+数据链路层`：链路层是用于定义物理传输通道，通常是对某些网络连接设备的驱动协议，例如针对光纤、网线提供的驱动

## 3. 谈传输层协议：TCP与UDP协议

通信的协议还是比较复杂的，`java.net` 包中包含的类和接口，它们提供低层次的通信细节。我们可以直接使用这些类和接口，来专注于网络程序开发，而不用考虑通信的细节

`java.net` 包中提供了两种常见的网络协议的支持：

- **UDP：**用户数据报协议
- **TCP**：传输控制协议

### 3.1 TCP协议与UDP协议

**TCP协议：**

- TCP协议进行通信的两个应用程序：客户端、服务端
- 使用TCP协议前，须先 `建立TCP连接` ，形成基于字节流的传输数据通道
- 传输前，采用“三次握手”方式，点对点通信，是`可靠的`
  - TCP协议使用 `重发机制`，当一个通信实体发送一个消息给另一个通信实体后，需要收到另一个李童心实体确认信息，如果没有收到另一个通信实体确认信息，则会再次重复刚刚发送的消息
- 在连接中可进行 `大数据量的传输`
- 传输完毕，需 `释放已建立的连接，效率低`

**UDP协议：**

- UDP协议进行通信的两个应用进程：发送端、接收端
- 将数据、源、目的封装成数据包（传输的基本单位），`不需要建立连接`
- 发送不管对方是否准备好，接收方收到也不确认，不能保证数据的完整性，故是 `不可靠的`
- 每个数据报的大小限制在 `64K` 以内
- 发送数据结束时 `无需释放资源，开销小，通信效率高`
- 适用场景：音频、视频和普通数据的传输。例如视频会议

> TCP生活案例：打电话
>
> UDP生活案例：发送短信、发电报

### 3.2 三次握手

TCP协议中，在发送数据的准备阶段，客户端与服务器之间的三次交互，以保证连接的可靠

- 第一次握手，客户端向服务器端发起TCP连接的请求
- 第二次握手，服务器端发送针对客户端TCP连接请求的确认
- 第三次握手，客户端发送确认的确认

 ![img](https://i-blog.csdnimg.cn/blog_migrate/48ca501712822a88fa93e67cbf982da9.png)

> 1、客户端会随机一个初始序列号seq=x，设置SYN=1，表示这是SYN握手报文，然后就可以把这个SYN报文发送给服务端了，表示向服务端发起连接，之后客户端处于 `同步已发送` 状态
>
> 2、服务端收到客户端的SYN报文后，也随机一个初始序列号（seq=y），设置ack=x+1，表示收到了客户端的x之前的数据，希望客户端下次发送的数据从x+1开始
>
> 设置SYN=1和ACK=1，表示这是一个SYN握手和ACK确认应答报文，最后把该报文发送给客户端，该报文也不包含应用层数据，之后服务端处于 `同步已接收` 状态
>
> 3、客户端收到服务端报文后，还要向服务端回应最后一个应答报文，将ACK设置为1，表示这是一个应答报文，ack=y+1，表示收到了服务器的y之前的数据，希望服务器下次发送的数据从y+1开始
>
> 最后把报文发送给服务端，这次报文可以携带数据，之后客户端处于 `连接已建立` 状态。服务器收到客户端的应答报文后，也进入 `连接已建立` 状态

完成三次握手，连接建立后，客户端和服务器就可以开始进行数据传输了。由于这种面向连接的特性，TCP协议可以保证传输数据的安全，所以应用十分广泛，例如下载文件、浏览网页等

### 3.3 四次挥手

TCP协议中，在发送数据结束后，释放连接时需要经过四次挥手

- 第一次挥手：客户端向服务器端提出结束连接，`让服务器做最后的准备工作`。此时，客户端处于半关闭状态，即表示不再向服务器发送数据了，但是还可以接收数据
- 第二次挥手：服务器接收到客户端释放连接的请求后，`会将最后的数据发送给客户端`，并告知上层的应用进程不再接收数据
- 第三次挥手：服务器端发送完数据后，会给客户端`发送一个释放连接的报文`，那么客户端接收后就知道可以正式释放连接了
- 第四次挥手：客户端接收到服务器最后的释放连接报文后，要`回复一个彻底断开的报文`，这样服务器收到后才会彻底释放连接。这里客户端发送完最后的报文后，会等待2MSL，因为有可能服务器没有接收到最后的报文，那么服务器迟迟没收到，就会再次给客户端发送释放连接的报文，此时客户端在等待时间范围内接收到，就会重新发送最后的报文，并重新计时，如果等待2MSL后，没有收到，那么彻底断开

 ![img](https://i-blog.csdnimg.cn/blog_migrate/b2eabc3d52deeb6822411c3c9694c9d4.jpeg) 

> 1、客户端打算断开连接，向服务器发送FIN报文（FIN标记位被设置为1，1表示为FIN，0表示不是），FIN报文中会指定一个序列号，之后客户端进入FIN_WAIT_1状态，也就是客户端法出连接释放报文段（FIN报文），指定序列号seq=x，主动关闭TCP连接，等待服务器的确认
>
> 2、服务器接收到释放连接报文段（FIN报文）后，就像客户端发送ACK应答报文，以客户端的FIN报文的序列号seq+1作为ACK应答报文段的确认序列号ack=seq+1=x+1.接着服务器进入CLOSE_WAIT（等待关闭）状态，此时的TCP处于半关毕状态，客户端到服务器的连接释放。客户端收到来自服务器的ACK应答报文后，进入FIN_WAIT_2状态
>
> 3、服务器也打算断开连接，向客户端发送连接释放报文段，之后服务器进入LAST_ACK状态，等待客户端的确认。服务器的连接释放报文段的FIN=1，ACK=1，序列号seq=z，确认序列号ack=x+1
>
> 4、客户端收到来自服务器的连接释放报文段后，会向服务器发送一个ACK应答报文段，以连接释放报文段的确认序号ack作为ACK应答报文段的序列号seq，以连接释放报文段的序列号seq+1作为确认序号ack
>
> 之后客户端进入TIME_WAIT状态，服务器收到ACK应答报文段后，服务器就进入CLOSE状态，到此服务器的连接已经完成关闭，客户端处于TIME_WAIT状态时，此时的TCP还未释放掉，需要等待2MSL后，服务器才进入CLOSE状态

## 4. 网络编程API

### 4.1 InetAddress类

- 作用：InetAddress类的一个实例就代表一个具体的ip地址
- 实例化方法：
  - `InetAddress getByName(String host)`:获取指定ip对应的InetAddress的实例
  - `InetAddressgetLocalHost()`:获取本地ip对应的InetAddress的实例
- 常用方法：
  - getHostName()
  - getHostAddress()

### 4.2 Socket类

- 网络上具有唯一标识的IP地址和端口号组合在一起构成唯一能识别的标识符套接字（Socket）
- 利用套接字（Socket）开发网络应用程序早已被广泛地采用，以至于成为事实上的标准。网络通信其实就是Socket间的通信
- 通信的两端都要有Socket，是两台机器间通信的端点
- Socket允许程序把网络连接当成一个流，数据在两个Socket间通过IO传输
- 一般主动发起通信的应用程序属客户端，等待通信请求的为服务端
- Socket分类：
  - 流套接字（stream socket）：使用TCP提供可依赖的字节流服务
    - ServerSocket：此类实现TCP服务套接字。服务器套接字等待请求通过网络传入
    - Socket：此类实现客户端套接字（也可以就叫“套接字”）。套接字是两台机器间通信的端点
  - 数据报套接字（datagram socket）：使用UDP提供“尽力而为”的数据报服务
    - DatagramSocket：此类用来标识发送和接收UDP数据报包的套接字

### 4.3 Socket相关类API

#### 4.3.1 ServerSocket类

**ServerSocket类的构造方法：**

#### 4.3.2 Socket类

#### 4.3.3 DatagramSocket类

#### 4.3.4 DatagramPacket类

## 5. TCP网络编程

### 5.1 通信模型

Java语言的基于套接字TCP编程分为服务端编程和客户端编程，其通信模型如图所示：

 ![Java_第16章_网络编程_宋红康网络聊天室-CSDN博客](https://img-blog.csdnimg.cn/376021d862f5481c89964e2edca8679c.png) 

### 5.2 开发步骤

**客户端程序包含以下四个基本的步骤：**

- 创建Socket：根据指定服务端的IP地址和端口号构造Socket类对象。若服务器端响应，则建立客户端到服务器的通信线路。若连接失败，会出现异常
- 打开连接到Socket的输入/输出流：使用getInputStream()方法获得输入流，使用getOutputStream()方法获得输出流，进行数据传输
- 按照一定的协议对Socket进行读写操作：通过输入流去读服务器放入线路的信息（但不能读取字节放入线路的信息），通过输出流将信息写入线路
- 关闭Socket：断开客户端到服务器的连接，释放线路

**服务器端程序包含以下四个基本的步骤：**

- 调用Server Socket(int port)：创建一个服务器端套接字，并绑定到指定端口上，用于监听客户端的需求
- 调用accept()：监听连接请求，如果客户端请求连接，则接受连接，返回通信套接字对象
- 调用该Socket类对象的getOutputStream()和getInputStream()：获取输出流和输入流，开始网络数据的发送和接受
- 关闭Socket对象：客户端访问结束，关闭通信套接字

### 5.3 例题与练习

> 例题1：客户端发送内容给服务端，服务端将内容打印到控制台上
>
> 例题2：客户端发送文件给服务端，服务端将文件保存在本地
>
> 例题3：从客户端发送文件给服务端，服务端保存到本地，并发送“发送成功”给客户端，并关闭相应的连接

练习1：服务端读取图片并发送给客户端，客户端保存图片到本地

练习2：客户端给服务端发送文本，服务端将文本转成大写再返回给客户端

**演示单个客户端与服务器单次通信：**

需求：客户端连接服务器，连接成功后给服务器发送“lalala”，服务器收到消息后，给客户端返回“欢迎登录”，客户端接收消息后，断开连接

**1、服务器端示例代码**

```java

```



### 5.4 案例：聊天室

### 5.5 理解客户端、服务端



## 6. UDP网络编程

### 6.1 通信模型

### 6.2 开发步骤